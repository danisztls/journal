#!/bin/bash
root="$HOME/Workshop"
hist="$root/JOURNAL.md"

# Colors
reset=$(printf '\033[0m')
bold_blue=$(printf '\033[1;34m')
red=$(printf '\033[31m')
green=$(printf '\033[32m')
magenta=$(printf '\033[35m')
cyan=$(printf '\033[36m')

function printTasks { # $1=regex_rule
	rg -N --color never --no-heading -t md -g '!JOURNAL.md' -e "$1" |
	sed 's/TODO: //;s/\r//' # delete todo preffix and carriage return escape code
}

function printPlain {
	printTasks "^TODO:.*\+done.*$"; printTasks "^TODO:.*\+asap.*$"; printTasks "^TODO:.[^\+]*$"; printTasks "^TODO:.*\+later.*$"
}

function prettify {
	sed 's/:/\n/' | awk '!x[$0]++' | # split & dedup
	sed "s/^.*\.md$/\n${bold_blue}&${reset}/;s/\+done/${green}&${reset}/;s/\+asap/${red}&${reset}/;s/\+later/${magenta}&${reset}/;s/[=<>].[^ ]*/${cyan}&${reset}/" # colorize	
} 

function printPretty {
	printTasks "^TODO:.*\+done.*$" | prettify
	printTasks "^TODO:.*\+asap.*$" | prettify
	printTasks "^TODO:.[^\+]*$" | prettify
	printTasks "^TODO:.*\+later.*$" | pretiffy
}

function fuzzy() {
	rg -t md -n --no-heading -g '!journal-*' -e 'TODO: ' -r '' | fzf --delimiter : --preview "fzf-bat-preview {1} {2}"
}


function confirmDialog {
	# shellcheck disable=SC2162 # it don't matter
	read -p "Are you sure? (y/N) " yn;
	case $yn in
		[Yy][Ee][Ss]|[Yy]) return 0;;
		[Nn][Oo]|[Nn]) return 1;;
		*) echo "Please answer yes or no." && return 1;;
	esac
}

function commitDone() { # write tasks done to journal file
	echo -e "## $(date "+%d de %B de %Y Ã s %H:%M")"
	rg -N --color never --no-heading -t md -g '!journal-*' -e "^TODO:.*\+done.*$" | sed 's/:/: /;s/\+done//' && echo -e ""
}

function deleteDone() {	# delete tasks done from their files
	for i in $(rg -N -t md -g '!journal-*' -e "^TODO:.*\+done.*$" | sed 's/:.*//' | awk '!x[$0]++'); do # iterate over files with tasks done
		sed -i '/\+done/d' "$i"
	done
}

function commitGit() { # non-interactively git commit all changes in root dir
	last_commit="git -C '$root' log HEAD^..HEAD --pretty=format:'%s'"  
	today_commit=$(date "+%y-%m-%d") 
	git -C "$root" add -A && if [[ "$today_commit" == "$last_commit" ]]; then
		git -C "$root" commit --amend -m "$today_commit" # amend if not first commit in the day
	else
		git -C "$root" commit -m "$today_commit"
	fi
}

cd "$root" || exit

case $1 in
	print) printPlain; exit 0;;
	show) printPretty | less -R; exit 0;;
	fuzzy) fuzzy; exit 0;;
	commit) confirmDialog && commitDone >> "$hist" && deleteDone && commitGit; exit 0;; 
esac

# Show help if no valid argument is parsed
echo -e "HELP:
\t'print' will print the tasks in stdout in plain mode;
\t'show' will show the tasks in a pager in pretty mode;
\t'fuzzy' will show tasks in fzf with note preview;
\t'commit' will clean tasks done, write them to a journal and git commit." && exit

